
/**
 * Module dependencies.
 */

 var crypto = require('crypto');

function serialize(options) {
    var algorithm = options.algorithm
      , secretKey = options.secretKey
      , encoding = options.encoding

    return function(request, response, callback) {
        response.serializeSend = function(json) {
            console.log('222222222');
            console.log(json);
            var cipher = crypto.createCipher(algorithm, secretKey);
            cipher.update(json, 'utf8', encoding);
            var serializeJson = cipher.final(encoding);
            console.log(serializeJson);
            response.send(serializeJson);
        }

        request.deserializeParam = function(key) {
            var decipher = crypto.createDecipher(algorithm, secretKey);
            decipher.update(request.param(key), encoding, 'utf8');
            var deserializeJson = decipher.final('utf8');
            return deserializeJson;
        }
        response._defaultRender = response.render;
        response.render = function(view, options, fn) {
            if (!options) {
                options = {};
            }
            console.log('00000000000000');

            var rf = request.param('rf') || request.param('responseFormat');

            if(!rf || rf !== 'json'){
                response._defaultRender(view, options, fn);
                return;
            }
console.log('111111111111111')
            response.send(JSON.stringify(options));
        }
        callback();
    }
}

module.exports = serialize;